# Nexus Homelab - Generated Docker Compose
# Services: {{ nexus_final_services | join(', ') }}
# Generated: {{ ansible_date_time.iso8601 }}
#
# DO NOT EDIT MANUALLY - This file is generated by Ansible
# To modify services, edit the individual service files in services/*/docker-compose.yml
# Then run: invoke deploy --preset home

{% set all_services = {} %}
{% set all_networks = {'proxy': {'external': true}} %}
{% set all_volumes = {} %}

{% for result in service_nexus_compose_files %}
{% if result.content is defined %}
{% set content = result.content | b64decode | from_yaml %}
{% if content.services is defined %}
{% for svc_name, svc_config in content.services.items() %}
{% set _ = all_services.update({svc_name: svc_config}) %}
{% endfor %}
{% endif %}
{% if content.networks is defined %}
{% for net_name, net_config in content.networks.items() %}
{% if net_name != 'proxy' %}
{% set _ = all_networks.update({net_name: net_config}) %}
{% endif %}
{% endfor %}
{% endif %}
{% if content.volumes is defined %}
{% for vol_name, vol_config in content.volumes.items() %}
{% set _ = all_volumes.update({vol_name: vol_config}) %}
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}

services:
{% for svc_name, svc_config in all_services.items() %}
  {{ svc_name }}:
{{ svc_config | to_nice_yaml(indent=2) | indent(4, first=True) }}
{% endfor %}

networks:
{% for net_name, net_config in all_networks.items() %}
  {{ net_name }}:
{% if net_config %}
{{ net_config | to_nice_yaml(indent=2) | indent(4, first=True) }}
{% else %}
    {}
{% endif %}
{% endfor %}

{% if all_volumes %}
volumes:
{% for vol_name, vol_config in all_volumes.items() %}
  {{ vol_name }}:
{% if vol_config %}
{{ vol_config | to_nice_yaml(indent=2) | indent(4, first=True) }}
{% else %}
    {}
{% endif %}
{% endfor %}
{% endif %}
