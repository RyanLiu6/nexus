---
# Docker installation and configuration tasks

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  changed_when: false
  failed_when: false

- name: Install Docker if not present
  block:
    - name: Install Docker (Ubuntu/Debian)
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose
          - python3-docker
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Docker (macOS)
      community.general.homebrew:
        name: docker
        state: present
      when: ansible_os_family == "Darwin"

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_env.USER }}"
        groups: docker
        append: yes
      become: yes

    - name: Start Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes
      when: ansible_os_family == "Debian"
  when: docker_check.rc != 0

- name: Create Docker network
  community.docker.docker_network:
    name: proxy
    state: present
  ignore_errors: yes

- name: Ensure Docker services directory exists
  ansible.builtin.file:
    path: "{{ nexus_root_directory }}/services"
    state: directory
    mode: "0755"
