---
# Docker installation and configuration tasks

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  changed_when: false
  failed_when: false

- name: Install Docker if not present
  when: docker_check.rc != 0
  block:
    - name: Install Docker (Ubuntu/Debian)
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose
          - python3-docker
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Install Docker (macOS)
      community.general.homebrew:
        name: docker
        state: present
      when: ansible_os_family == "Darwin"

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_env.USER }}"
        groups: docker
        append: true
      become: true

    - name: Start Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
      when: ansible_os_family == "Debian"

- name: Create Docker network
  community.docker.docker_network:
    name: nexus
    state: present
  failed_when: false

- name: Ensure Docker services directory exists
  ansible.builtin.file:
    path: "{{ nexus_root_directory }}/services"
    state: directory
    mode: "0755"
