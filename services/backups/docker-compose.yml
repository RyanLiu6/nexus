services:
  backrest:
    image: ghcr.io/garethgeorge/backrest:latest
    container_name: backrest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - nexus
    environment:
      - TZ=${TZ}
      - BACKREST_DATA=/data
      - BACKREST_CONFIG=/config/config.json
      - XDG_CACHE_HOME=/cache
      - BACKREST_PORT=0.0.0.0:9898
      - RESTIC_PASSWORD=${RESTIC_PASSWORD}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9898/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ${NEXUS_DATA_DIRECTORY}/Config/backrest/config:/config
      - ${NEXUS_DATA_DIRECTORY}/Config/backrest/data:/data
      - ${NEXUS_DATA_DIRECTORY}/Config/backrest/cache:/cache
      - ${NEXUS_DATA_DIRECTORY}/Config/backrest/rclone:/root/.config/rclone:ro
      - ${NEXUS_DATA_DIRECTORY}/Config:/userdata:ro
      - ${NEXUS_DATA_DIRECTORY}/Backups:/repos
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backrest.rule=Host(`backups.${DOMAIN}`)"
      - "traefik.http.routers.backrest.entrypoints=websecure"
      - "traefik.http.routers.backrest.tls=true"
      - "traefik.http.routers.backrest.tls.certresolver=cloudflare"
      - "traefik.http.services.backrest.loadbalancer.server.port=9898"

networks:
  nexus:
    external: true
