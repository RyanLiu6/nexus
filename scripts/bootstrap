#!/bin/bash
set -e

echo "ðŸš€ Bootstrapping Nexus..."

# Detect OS
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
else
    echo "âŒ Unsupported OS: $OSTYPE"
    exit 1
fi

echo "ðŸ“¦ Detected OS: $OS"

# Install uv if not found
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.cargo/env
fi

# Install system dependencies
if [[ "$OS" == "macos" ]]; then
    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    for pkg in ansible terraform; do
        if ! command -v $pkg &> /dev/null; then
            echo "Installing $pkg..."
            brew install $pkg
        fi
    done

    if ! command -v docker &> /dev/null; then
        echo "Installing Docker..."
        brew install --cask docker
        echo "Please open Docker Desktop to complete setup"
    fi
else
    sudo apt update
    sudo apt install -y ansible software-properties-common

    if ! command -v terraform &> /dev/null; then
        wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
        sudo apt update && sudo apt install -y terraform
    fi

    if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | sh
        sudo usermod -aG docker "$USER"
    fi
fi

echo "Syncing dependencies..."
uv sync --all-extras

echo "Activating virtual environment..."
source .venv/bin/activate

echo "Installing pre-commit hooks..."
pre-commit install

echo ""
echo "âœ… Bootstrap complete! Next steps:"
echo "  inv setup        # Create vault and network"
echo "  inv deploy       # Deploy services"
echo ""
